
You are Copilot (or a similar IDE assistant). Generate the FastAPI endpoints and project scaffolding for the **OpenAI Personal Assistant Environment**. Use the user's provided `.env` values as defaults for local dev. The repository may already contain code; create new files if missing and skip overwriting existing non-empty files unless changes are explicitly requested by TODO comments you insert.

──────────────────────────────────────────────────────────────────────────────
# GOALS
- Provide a single FastAPI backend exposing secure endpoints for memory, fs, fetch, ssh, agents, prompts, and feedback; plus health/version and OpenAPI export.
- Keep destructive ops "dry-run" by default unless `confirm=true` is supplied.
- Enforce API/Bearer auth on every route via dependency injection and light rate-limiting hook.
- Use Postgres 16 (+ pgvector) and optional Redis. Read-only FS under `/work`. Strict allow-lists for fetch/ssh.
- Include n8n integration stubs for "agents" orchestration (create/resolve/run) but keep side effects behind confirmation.
- Include tests, docker-compose (core1, core3), Nginx+cloudflared stubs, and scripts.
- Preserve portability: all configuration via environment variables (see below).

──────────────────────────────────────────────────────────────────────────────
# ENVIRONMENT (use as defaults for local dev)
Create `.env.example` and load via env vars. The user provided:
```
APP_ENV=dev
APP_HOST=0.0.0.0
APP_PORT=8080
API_KEY=dev-api-key-12345-for-local-testing
LOG_LEVEL=INFO

# Database
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=opa
POSTGRES_USER=opa
POSTGRES_PASSWORD=opa_password

# Optional Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Security / allow-lists
FETCH_DOMAIN_ALLOWLIST=example.com,api.github.com
SSH_HOSTS_ALLOWLIST=core1,core3
FS_ROOT=/work

# CORS Origins (comma-separated)
CORS_ORIGINS=https://chat.openai.com,https://chatgpt.com
```
Notes:
- OK for local. For prod, generate a strong `API_KEY`, restrict allow-lists, and consider Cloudflare Access + Nginx rate-limits. Keep FS read-only. Never hard-code secrets.

──────────────────────────────────────────────────────────────────────────────
# TARGET TREE (create these if missing)
```
/backend
  /app
    /core
      db.py
      allowlists.py
      rate_limit.py
      scheduler.py
      n8n_client.py           # stub for agent orchestration
      vaultwarden_client.py   # stub for secret fetch, server-side only
    /deps
      auth.py
    /routers
      health.py
      memory.py
      fs.py
      fetch.py
      ssh.py
      agents.py
      prompts.py
      feedback.py
    /schemas
      common.py
      memory.py
      agents.py
      prompts.py
      feedback.py
    main.py
  /openapi
    actions.json              # generated by script
  /tests
    test_health.py
    test_memory.py
    test_fs_safety.py
    test_fetch_safety.py
    test_auth.py
  /docker
    compose.core1.yml
    compose.core3.yml
    nginx/conf.d/fastapi.conf
    cloudflared/config.yml
.env.example
/docs
  ACTIONS_SETUP.md
  SECURITY.md
  GMAIL_PUSH_SETUP.md
/scripts
  dev_seed_memory.py
  export_openapi.sh
  wait-for-it.sh
README.md (present already)
```

──────────────────────────────────────────────────────────────────────────────
# PYTHON & DEPENDENCIES
- Python 3.11
- fastapi, uvicorn[standard], pydantic>=2, httpx, python-dotenv
- sqlalchemy[asyncio], asyncpg, psycopg[binary], pgvector
- orjson, ujson (optional), loguru
- redis (optional)
- pytest, httpx[http2], pytest-asyncio
- ruff, black

Create `pyproject.toml` with these dependencies and tooling.

──────────────────────────────────────────────────────────────────────────────
# IMPLEMENTATION DETAILS (FILES TO GENERATE)

## 1) main.py
- Initialize FastAPI.
- Include CORS from `CORS_ORIGINS` (comma-separated) if present.
- Mount routers: health, memory, fs, fetch, ssh, agents, prompts, feedback (all under `/`).
- Startup: connect DB and enable pgvector (if not exists). Shutdown: close engine.
- Routes available: `/`, `/healthz`, `/version`, plus all router paths.
- Expose OpenAPI at `/openapi.json`.

## 2) deps/auth.py
- Provide `api_auth` dependency:
  - Expect `Authorization: Bearer <API_KEY>`.
  - If missing/invalid, raise 401 JSON with `{"detail":"Unauthorized"}`.
  - Call `rate_limit.check_quota(subject)` (no-op placeholder).

## 3) core/db.py
- Create async SQLAlchemy engine from env.
- Ensure `pgvector` extension enabled on startup (`CREATE EXTENSION IF NOT EXISTS vector;`).
- Provide `get_session()` as async generator.

## 4) core/allowlists.py
- `get_domain_allowlist()` from env `FETCH_DOMAIN_ALLOWLIST`.
- `get_ssh_hosts_allowlist()` from env `SSH_HOSTS_ALLOWLIST`.
- `FS_ROOT` from env (default `/work`).
- `is_safe_command(cmd)` → allow simple safe commands only: `"uptime"`, `"df -h"`, `"whoami"` (placeholder).

## 5) core/rate_limit.py (placeholder)
- `check_quota(subject: str) -> None` (no-op; TODO integrate Redis token bucket).

## 6) core/scheduler.py (placeholder)
- Provide `init_scheduler()` and a sample daily job that logs a memory digest tick.

## 7) core/n8n_client.py (stub)
- Methods: `create_workflow(json)`, `run_workflow(workflow_id, params)`, `get_execution(exec_id)`, `upsert_credential(name, data)`.
- For now, just raise `NotImplementedError` with TODOs.

## 8) core/vaultwarden_client.py (stub)
- `fetch_secret(ref: str) -> str` (server-side only). Return masked placeholder in dev.

## 9) routers/health.py
- `GET /` → `{service:"OPA FastAPI", env, now}`.
- `GET /healthz` → `{ok:true}`.
- `GET /version` → `{version: <sha or "dev">}`.

## 10) schemas/common.py
- Standard `ErrorOut`, `DryRunOut`, `OkOut` pydantic models.

## 11) schemas/memory.py
```
class MemoryWriteIn(BaseModel):
    text: str
    tags: list[str] = []
    speaker_id: str | None = None
    ts_iso: str | None = None

class MemorySearchIn(BaseModel):
    query: str
    since: str | None = None
    until: str | None = None
    tags: list[str] = []
    top_k: int = 10

class MemoryHit(BaseModel):
    id: int
    text: str
    score: float
    tags: list[str] = []
    ts_iso: str | None = None

class MemorySearchOut(BaseModel):
    hits: list[MemoryHit]
```
Add a simple `hash_embed(text: str) -> list[float]` placeholder to produce a deterministic vector.

## 12) routers/memory.py
- Table `memory_items(id serial PK, text text, tags text[], ts timestamptz, speaker_id text, embedding vector)`.
- `POST /memory/write`: insert row; embedding via `hash_embed(text)`.
- `POST /memory/search`: hybrid search combining full-text/BM25 (or simple ts_rank if using FTS) and vector similarity (`embedding <#> query_vec`). Merge by reciprocal rank or weighted sum; return top_k.

## 13) routers/fs.py (read-only)
- `GET /fs/list?path&maxDepth=1`: normalize under `FS_ROOT`; deny `..` and symlinks; list directories/files.
- `GET /fs/read?path&bytes=65536`: only text (basic binary sniff). Return first N bytes.

## 14) routers/fetch.py (safe HTTP)
- `GET /fetch/get?url&max_bytes=262144`:
  - HTTPS only.
  - Host must be in allow-list; resolve DNS and block private/metadata IP ranges.
  - Stream up to `max_bytes`. Return `{status, content_type, size, text[:N]}`.

## 15) routers/ssh.py (confirm pattern)
- `POST /ssh/exec {host, cmd, timeout_sec?, confirm?}`:
  - Host in allow-list; `is_safe_command(cmd)` true.
  - If `confirm != true`: return dry-run preview.
  - Else execute via subprocess with timeout<=10s; return `{stdout, stderr, exit_code}`.

## 16) schemas/agents.py
- Define `AgentManifest`, `AgentCreateIn`, `AgentResolveIn`, `AgentRunIn`, `AgentOut`, `AgentRunOut`, `SecretLinkIn`.

## 17) routers/agents.py (MVP)
- `POST /agents/resolve {query, context?}` → search `agents` table or return proposal.manifest (stub).
- `POST /agents/create {manifest, confirm}` → dry-run unless confirm; else persist + call `n8n_client.create_workflow`.
- `POST /agents/run {agent_id, params, confirm}` → enforce confirm for sensitive; call `n8n_client.run_workflow`.
- `POST /agents/secrets/link` → use `vaultwarden_client.fetch_secret` then `n8n_client.upsert_credential`.

## 18) schemas/prompts.py & routers/prompts.py
- Register/list/update prompt templates by role and tags; expose success stats fields.

## 19) schemas/feedback.py & routers/feedback.py
- Accept auto-grades and human thumbs; persist per interaction.

──────────────────────────────────────────────────────────────────────────────
# TESTS (minimal)
- `test_health.py`: `/healthz` 200 ok.
- `test_auth.py`: 401 without Bearer; 200 with correct Bearer.
- `test_memory.py`: write -> search -> assert order; tags filter.
- `test_fs_safety.py`: traversal denied.
- `test_fetch_safety.py`: non-https and disallowed host denied.

──────────────────────────────────────────────────────────────────────────────
# DOCKER COMPOSE (core1/core3)

## compose.core1.yml
- Services: `api`, `postgres:16`, `redis:7` (optional), `n8n` (optional).
- Mount project into `api` for dev; expose 8080.
- Init SQL to `CREATE EXTENSION IF NOT EXISTS vector;`.
- Bind `/srv/work` (if exists) to `/work` read-only.

## compose.core3.yml
- `nginx` with `fastapi.conf` (TLS, reverse proxy to Core1 host/IP).
- `cloudflared` with a tunnel config that maps public host → `nginx`.

──────────────────────────────────────────────────────────────────────────────
# SCRIPTS
- `wait-for-it.sh`: standard wait helper.
- `dev_seed_memory.py`: insert seed memory rows.
- `export_openapi.sh`: write `/openapi/actions.json` from running server.

──────────────────────────────────────────────────────────────────────────────
# ACCEPTANCE CRITERIA
- `/healthz` and `/openapi.json` reachable behind auth where appropriate.
- Memory write/search functional with deterministic embeddings.
- FS/Fetch/SSH enforce allow-lists and confirm pattern.
- Agents/Prompts/Feedback endpoints exist and return sensible dry-run outputs.
- `pytest -q` passes locally.
- `docker compose -f backend/docker/compose.core1.yml up -d` starts API+DB.

# END OF INSTRUCTIONS
